# API 後端路由
location /api/ {
    # Rate Limiting
    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 10;

    proxy_pass http://backend_api;
    proxy_http_version 1.1;

    # Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;

    # Connection keep-alive
    proxy_set_header Connection "";

    # 超時設定
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # 緩存禁用 (API 響應)
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}

# WebSocket 支持
location /ws/ {
    proxy_pass http://backend_api;
    proxy_http_version 1.1;

    # WebSocket 必需的 Headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket 超時設定（更長）
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;

    # 禁用緩衝
    proxy_buffering off;
}

# API 文檔 (開發環境可訪問，生產環境應該關閉或需要認證)
location /docs {
    # 生產環境：取消註釋下面這行以禁用 API 文檔
    # return 404;

    proxy_pass http://backend_api;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /redoc {
    # 生產環境：取消註釋下面這行以禁用 API 文檔
    # return 404;

    proxy_pass http://backend_api;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /openapi.json {
    # 生產環境：取消註釋下面這行以禁用 API 文檔
    # return 404;

    proxy_pass http://backend_api;
    proxy_set_header Host $host;
}

# 健康檢查端點
location /health {
    access_log off;
    proxy_pass http://backend_api/health;
    proxy_set_header Host $host;
}

# 靜態資源 (Next.js)
location /_next/static/ {
    proxy_pass http://frontend_app;
    proxy_http_version 1.1;
    proxy_set_header Host $host;

    # 靜態資源緩存 (1 年)
    add_header Cache-Control "public, max-age=31536000, immutable";
}

# Next.js 圖片優化
location /_next/image {
    proxy_pass http://frontend_app;
    proxy_http_version 1.1;
    proxy_set_header Host $host;

    # 圖片緩存 (1 天)
    add_header Cache-Control "public, max-age=86400";
}

# 前端應用（所有其他路由）
location / {
    proxy_pass http://frontend_app;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;

    # Connection keep-alive
    proxy_set_header Connection "";

    # 超時設定
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # HTML 不緩存
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}
